name: E-Commerce CI/CD Pipeline

on:
  push:
    branches:
      - testing
  pull_request:
    branches:
      - main 
  workflow_dispatch:

jobs:
  stage1-build-test:
    name: Build and Test Docker Images
    runs-on: ubuntu-latest
    if: github.event_name == 'push' && github.ref == 'refs/heads/testing' || github.event_name == 'workflow_dispatch'

    services:
      postgres:
        image: postgres:15
        env:
          POSTGRES_USER: postgres
          POSTGRES_PASSWORD: postgres
          POSTGRES_DB: products
        ports:
          - 5432:5432
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5

    steps:
    - name: Checkout Code
      uses: actions/checkout@v3

    - name: Wait for PostgreSQL
      run: |
        until pg_isready -h localhost -p 5432; do
          echo "Waiting for PostgreSQL..."
          sleep 2
        done

    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'

    - name: Install backend dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r backend/product_service/requirements.txt
        pip install -r backend/order_service/requirements.txt
        pip install pytest psycopg2-binary

    - name: Run Backend Tests
      run: |
        cd backend/product_service && pytest tests/
        cd ../../backend/order_service && pytest tests/

    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v2

    - name: Log in to ACR
      uses: azure/docker-login@v1
      with:
        login-server: week8.azurecr.io
        username: ${{ secrets.ACR_USERNAME }}
        password: ${{ secrets.ACR_PASSWORD }}

    - name: Build Docker images
      run: |
        docker build -t week8.azurecr.io/product_service:latest ./backend/product_service
        docker build -t week8.azurecr.io/order_service:latest ./backend/order_service
        docker build -t week8.azurecr.io/frontend:latest ./frontend

    - name: Push Images to ACR
      if: success()
      run: |
        docker push week8.azurecr.io/product_service:latest
        docker push week8.azurecr.io/order_service:latest
        docker push week8.azurecr.io/frontend:latest

  stage2-staging:
    name: Deploy to Staging Environment
    runs-on: ubuntu-latest
    needs: stage1-build-test

    steps:
    - name: Checkout Code
      uses: actions/checkout@v3

    - name: Prepare kubeconfig
      run: |
        mkdir -p $HOME/.kube
        echo "${{ secrets.STAGING_KUBECONFIG }}" > $HOME/.kube/config
        chmod 600 $HOME/.kube/config

    - name: Set kubectl context
      uses: azure/setup-kubectl@v3
      with:
        version: 'v1.30.0'

    - name: Create staging namespace
      run: kubectl create ns staging || echo "Namespace exists"

    - name: Deploy to staging
      run: |
        kubectl apply -n staging -f k8s/configmaps.yaml
        kubectl apply -n staging -f k8s/product-db.yaml
        kubectl apply -n staging -f k8s/order-db.yaml
        kubectl apply -n staging -f k8s/product-service.yaml
        kubectl apply -n staging -f k8s/order-service.yaml
        kubectl apply -n staging -f k8s/frontend.yaml

    - name: Destroy staging environment
      run: kubectl delete ns staging || echo "Namespace already deleted"

  stage3-production:
    name: Deploy to Production
    runs-on: ubuntu-latest
    if: github.event_name == 'push' && github.ref == 'refs/heads/testing' || github.event_name == 'workflow_dispatch'

    steps:
    - name: Checkout Code
      uses: actions/checkout@v3

    - name: Prepare kubeconfig
      run: |
        mkdir -p $HOME/.kube
        echo "${{ secrets.PROD_KUBECONFIG }}" > $HOME/.kube/config
        chmod 600 $HOME/.kube/config

    - name: Set kubectl context
      uses: azure/setup-kubectl@v3
      with:
        version: 'v1.30.0'

    - name: Deploy to production
      run: |
        kubectl apply --validate=false -f k8s/configmaps.yaml
        kubectl apply --validate=false -f k8s/product-db.yaml
        kubectl apply --validate=false -f k8s/order-db.yaml
        kubectl apply --validate=false -f k8s/product-service.yaml
        kubectl apply --validate=false -f k8s/order-service.yaml
        kubectl apply --validate=false -f k8s/frontend.yaml
